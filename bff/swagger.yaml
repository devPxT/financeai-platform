openapi: 3.0.3
info:
  title: FinanceAI BFF / API Gateway
  version: 1.0.1
  description: |
    Backend-for-Frontend que atua como API Gateway para o MFE.
    Responsável por autenticação (Clerk/mock), agregação, integração com Stripe, OpenAI,
    encaminhamento para Azure Functions (transações) e para microservices (transactions-service, analytics-service).

servers:
  - url: https://financeaibff-e4frhjfnadhybtfy.canadacentral-01.azurewebsites.net
    description: Produção
  - url: http://localhost:4000
    description: Local Dev
tags:
  - name: Health
  - name: Auth
  - name: Transactions
  - name: Stripe
  - name: Reports
  - name: Analytics
  - name: Functions
  - name: Internal
  - name: Metrics
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Error:
      type: object
      properties:
        error: { type: string }
        detail: { type: string }
        details: { type: string }
    TransactionCreate:
      type: object
      required: [name, amount, type, category, paymentMethod]
      properties:
        name: { type: string }
        amount: { type: number }
        type:
          type: string
          enum: [Despesa, Depósito, Investimento]
        category:
            type: string
            enum: [Educação, Entretenimento, Alimentação, Saúde, Moradia, Outros, Salário, Transporte, Utilidades]
        paymentMethod:
          type: string
          enum: [Transferência Bancária, Boleto Bancário, Dinheiro, Cartão de Crédito, Cartão de Débito, Outros, Pix]
        date: { type: string, format: date }
    TransactionUpdate:
      type: object
      properties:
        name: { type: string }
        amount: { type: number }
        type: { type: string, enum: [Despesa, Depósito, Investimento] }
        category:
          type: string
          enum: [Educação, Entretenimento, Alimentação, Saúde, Moradia, Outros, Salário, Transporte, Utilidades]
        paymentMethod:
          type: string
          enum: [Transferência Bancária, Boleto Bancário, Dinheiro, Cartão de Crédito, Cartão de Débito, Outros, Pix]
        date: { type: string, format: date }
    Transaction:
      type: object
      properties:
        id: { type: string }
        userId: { type: string }
        name: { type: string }
        type: { type: string }
        category: { type: string }
        paymentMethod: { type: string }
        amount: { type: number }
        date: { type: string, format: date-time }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    AggregateResponse:
      type: object
      properties:
        userId: { type: string }
        balance: { type: number }
        series:
          type: array
          items:
            type: object
            properties:
              month: { type: string }
              value: { type: number }
        recent:
          type: array
          items: { $ref: '#/components/schemas/Transaction' }
        fromCache: { type: boolean }
    CheckoutSessionRequest:
      type: object
      properties:
        successUrl: { type: string }
        cancelUrl: { type: string }
    CheckoutSessionResponse:
      type: object
      properties:
        url: { type: string }
        id: { type: string }
    ReportGenerateResponse:
      type: object
      properties:
        report: { type: string }
    ReportQuota:
      type: object
      properties:
        limit: { type: integer }
        used: { type: integer }
        remaining: { type: integer }
    ReportItem:
      type: object
      properties:
        id: { type: string }
        userId: { type: string }
        createdAt: { type: string, format: date-time }
        title: { type: string }
        msg: { type: string }
    ReportListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/ReportItem' }
        page: { type: integer }
        limit: { type: integer }
        total: { type: integer }
    MetricsResponse:
      type: object
      properties:
        uptime: { type: number }
        ts: { type: string, format: date-time }
        cacheKeys: { type: integer }
paths:
  /bff/health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
  /bff/whoami:
    get:
      tags: [Auth]
      security: [{ bearerAuth: [] }]
      summary: Dados do usuário autenticado
      responses:
        '200': { description: OK }
        '401': { description: Falha de autenticação }
  /bff/aggregate:
    get:
      tags: [Transactions]
      security: [{ bearerAuth: [] }]
      summary: Agrega saldo, série temporal e últimas transações
      parameters:
        - in: query
          name: userId
          schema: { type: string }
          description: "Usado apenas em MOCK_AUTH"
      responses:
        '200':
          description: Agregado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AggregateResponse' }
        '401':
          description: Usuário ausente
  /bff/transactions:
    get:
      tags: [Transactions]
      security: [{ bearerAuth: [] }]
      summary: Listar transações do usuário
      parameters:
        - in: query
          name: userId
          schema: { type: string }
          description: "Apenas em MOCK_AUTH"
      responses:
        '200':
          description: Lista
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Transaction' }
    post:
      tags: [Transactions]
      security: [{ bearerAuth: [] }]
      summary: Criar transação (via Azure Function)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TransactionCreate' }
      responses:
        '201': { description: Criada }
        '400': { description: Payload inválido }
        '401': { description: Usuário ausente }
  /bff/transactions/{id}:
    put:
      tags: [Transactions]
      security: [{ bearerAuth: [] }]
      summary: Atualizar transação (via Function)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TransactionUpdate' }
      responses:
        '200': { description: Atualizada }
        '400': { description: Erro validação }
        '404': { description: Não encontrada }
    delete:
      tags: [Transactions]
      security: [{ bearerAuth: [] }]
      summary: Remover transação (via Function)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: Removida }
        '404': { description: Não encontrada }
  /bff/create-checkout-session:
    post:
      tags: [Stripe]
      security: [{ bearerAuth: [] }]
      summary: Cria sessão de checkout (Stripe)
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CheckoutSessionRequest' }
      responses:
        '200':
          description: Sessão criada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CheckoutSessionResponse' }
  /bff/stripe-webhook:
    post:
      tags: [Stripe]
      summary: Webhook de eventos Stripe
      description: "Verifica assinatura; não usa bearer auth."
      responses:
        '200': { description: Recebido }
        '400': { description: Assinatura inválida }
  /bff/report:
    post:
      tags: [Reports]
      security: [{ bearerAuth: [] }]
      summary: Gera relatório (OpenAI) e tenta persistir
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ReportGenerateResponse' }
        '429': { description: Limite atingido }
  /bff/reports/quota:
    get:
      tags: [Reports]
      security: [{ bearerAuth: [] }]
      summary: Quota mensal de relatórios
      responses:
        '200':
          description: Quota
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ReportQuota' }
  /bff/reports:
    get:
      tags: [Reports]
      security: [{ bearerAuth: [] }]
      summary: Listar relatórios
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: limit
          schema: { type: integer, default: 10 }
      responses:
        '200':
          description: Página
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ReportListResponse' }
  /bff/function-event:
    post:
      tags: [Functions]
      security: [{ bearerAuth: [] }]
      summary: Encaminha evento arbitrário para Function /event
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { description: OK }
        '502': { description: Falha na Function }
  /internal/seed:
    post:
      tags: [Internal]
      summary: Seed nos microservices
      parameters:
        - in: header
          name: x-internal-secret
          schema: { type: string }
          required: true
      responses:
        '200': { description: OK }
        '401': { description: Segredo inválido }
  /bff/metrics:
    get:
      tags: [Metrics]
      summary: Métricas simples
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/MetricsResponse' }